<script lang="ts">
import { computed, defineComponent, ref, watchEffect } from 'vue'
import { useStore } from 'vuex'
import { key } from '@/store'
import { computeKeyframes } from '@/helpers'

export default defineComponent({
  props: {},
  components: {},

  setup() {
    const store = useStore(key)
    const points = computed(() => store.state.points)
    const options = computed(() => store.state.options)
    const previewElement = ref<HTMLDivElement>()
    const animation = ref<Animation>()

    watchEffect(() => {
      if (previewElement.value) {
        const keyframes = computeKeyframes(points.value, options.value)

        if (animation.value) animation.value.cancel()
        animation.value = previewElement.value.animate(keyframes, {
          duration: options.value.duration,
          iterations: Infinity
        })
      }
    })

    return { previewElement }
  }
})
</script>

<template>
  <div class="preview">
    <div class="preview__element" ref="previewElement">
      <svg viewBox="0 0 128 128" fill="none">
        <path
          d="M64 0C28.6538 0 0 28.6538 0 64C0 72.249 1.56075 80.1337 4.40275 87.3745C13.7388 111.16 36.9028 124.137 64 124.137C91.0972 124.137 114.261 111.16 123.597 87.3745C126.439 80.1337 128 72.249 128 64C128 28.6538 99.3462 0 64 0V0ZM64 80.3173C54.9882 80.3173 47.6828 73.0118 47.6828 64C47.6828 54.9882 54.9882 47.6828 64 47.6828C73.0118 47.6828 80.3173 54.9882 80.3173 64C80.3173 73.0118 73.0118 80.3173 64 80.3173Z"
          fill="#FEAEE1"
        />
        <path
          d="M64 0C62.7025 0 61.4152 0.04325 60.1367 0.1195C93.6837 2.11725 120.274 29.9512 120.274 64C120.274 98.0488 93.6837 125.883 60.137 127.881C61.4152 127.957 62.7025 128 64 128C77.8472 128 90.0195 121.851 100.492 114.376C110.513 107.223 119.032 99.005 123.597 87.3745C126.439 80.1337 128 72.249 128 64C128 28.6538 99.3462 0 64 0V0Z"
          fill="#FE93D3"
        />
        <path
          d="M123.596 87.374H122.998C113.165 87.374 113.165 98.706 103.331 98.706C93.4978 98.706 93.4978 87.374 83.6643 87.374C73.8313 87.374 73.8312 98.706 63.9982 98.706C54.1655 98.706 54.1655 87.374 44.333 87.374C34.5002 87.374 34.5002 98.706 24.6672 98.706C14.8345 98.706 14.8345 87.374 5.00175 87.374H4.40375C13.74 111.16 36.903 128 64 128C91.097 128 114.26 111.16 123.596 87.374Z"
          fill="#D1A08F"
        />
        <path
          d="M123.596 87.374H122.998C113.165 87.374 113.165 98.706 103.331 98.706C93.4978 98.706 93.4978 87.374 83.6643 87.374C73.8313 87.374 73.8312 98.706 63.9982 98.706C54.1655 98.706 54.1655 87.374 44.333 87.374C34.5002 87.374 34.5002 98.706 24.6672 98.706C14.8345 98.706 14.8345 87.374 5.00175 87.374H4.40375C13.74 111.16 36.903 128 64 128C91.097 128 114.26 111.16 123.596 87.374Z"
          fill="#D1A08F"
        />
        <path
          d="M123.596 87.374H122.998C118.322 87.374 115.869 89.9368 113.526 92.625C103.562 112.511 83.5447 126.487 60.1367 127.881C60.1387 127.882 60.1407 127.884 60.1427 127.885C61.419 127.961 62.705 128 64 128C91.097 128 114.26 111.16 123.596 87.374Z"
          fill="#C68D7A"
        />
        <path
          d="M103.489 49.9025C101.56 50.8153 99.2568 49.9915 98.3443 48.063L93.023 36.8185C92.1105 34.8898 92.9345 32.587 94.8625 31.674C96.791 30.7613 99.0943 31.585 100.007 33.5135L105.328 44.758C106.253 46.709 105.369 49.0128 103.489 49.9025Z"
          fill="white"
        />
        <path
          d="M48.2912 36.611C50.2837 35.848 51.2802 33.6142 50.517 31.6217L46.0677 20.0047C45.3045 18.0122 43.0708 17.0162 41.0783 17.7787C39.0858 18.5417 38.0893 20.7755 38.8525 22.768L43.3018 34.385C44.0723 36.4017 46.3487 37.355 48.2912 36.611V36.611Z"
          fill="white"
        />
        <path
          d="M13.1297 52.5957C14.1692 54.459 16.5222 55.1265 18.3855 54.087L29.249 48.026C31.1122 46.9862 31.7792 44.6332 30.7405 42.77C29.701 40.9067 27.348 40.2392 25.4847 41.2787L14.6212 47.3397C12.7347 48.39 12.1162 50.7792 13.1297 52.5957V52.5957Z"
          fill="#AEE69C"
        />
        <path
          d="M15.509 69.3932C14.8607 71.426 15.983 73.5992 18.0157 74.2475L29.8675 78.0272C31.9002 78.6752 34.0732 77.5527 34.722 75.5205C35.3702 73.4877 34.248 71.3145 32.2152 70.6662L20.3635 66.8865C18.307 66.2287 16.141 67.4115 15.509 69.3932V69.3932Z"
          fill="#FFE179"
        />
        <path
          d="M97.9467 75.441C98.9382 77.3302 101.274 78.0577 103.163 77.066L114.177 71.2845C116.067 70.2927 116.794 67.9575 115.803 66.0682C114.811 64.179 112.476 63.4515 110.587 64.4432L99.572 70.2247C97.6593 71.2265 96.98 73.5992 97.9467 75.441V75.441Z"
          fill="#AEE69C"
        />
        <path
          d="M68.6065 29.884C66.7363 28.8572 66.0528 26.5085 67.0798 24.6385L73.067 13.7342C74.0943 11.864 76.4425 11.181 78.3128 12.2072C80.183 13.2342 80.8665 15.5827 79.8395 17.4527L73.8523 28.357C72.8148 30.2505 70.4298 30.885 68.6065 29.884Z"
          fill="#FFE179"
        />
      </svg>
      <svg viewBox="0 0 128 128" fill="none" class="back">
        <path
          d="M64 0C99.3462 0 128 28.6538 128 64C128 72.249 126.439 80.1337 123.597 87.3745C114.261 111.16 91.0972 124.137 64 124.137C36.9028 124.137 13.739 111.16 4.403 87.3745C1.561 80.1337 0 72.249 0 64C0 28.6538 28.6538 0 64 0ZM64 80.3173C73.0118 80.3173 80.3172 73.0118 80.3172 64C80.3172 54.9882 73.0118 47.6828 64 47.6828C54.9882 47.6828 47.6827 54.9882 47.6827 64C47.6827 73.0118 54.9882 80.3173 64 80.3173Z"
          fill="#FEAEE1"
        />
        <path
          d="M64 0C65.2975 0 66.5848 0.04325 67.8633 0.1195C34.3163 2.11725 7.72598 29.9512 7.72598 64C7.72598 98.0488 34.3163 125.883 67.863 127.881C66.5848 127.957 65.2975 128 64 128C50.1528 128 37.9805 121.851 27.508 114.376C17.487 107.223 8.96798 99.005 4.40298 87.3745C1.56098 80.1337 -1.52588e-05 72.249 -1.52588e-05 64C-1.52588e-05 28.6538 28.6538 0 64 0Z"
          fill="#FE93D3"
        />
        <path
          d="M4.404 87.374H5.002C14.835 87.374 14.835 98.706 24.669 98.706C34.5022 98.706 34.5022 87.374 44.3357 87.374C54.1687 87.374 54.1688 98.706 64.0018 98.706C73.8345 98.706 73.8345 87.374 83.667 87.374C93.4998 87.374 93.4998 98.706 103.333 98.706C113.166 98.706 113.166 87.374 122.998 87.374H123.596C114.26 111.16 91.097 128 64 128C36.903 128 13.74 111.16 4.404 87.374Z"
          fill="#D1A08F"
        />
        <path
          d="M4.404 87.374H5.002C14.835 87.374 14.835 98.706 24.669 98.706C34.5022 98.706 34.5022 87.374 44.3357 87.374C54.1687 87.374 54.1688 98.706 64.0018 98.706C73.8345 98.706 73.8345 87.374 83.667 87.374C93.4998 87.374 93.4998 98.706 103.333 98.706C113.166 98.706 113.166 87.374 122.998 87.374H123.596C114.26 111.16 91.097 128 64 128C36.903 128 13.74 111.16 4.404 87.374Z"
          fill="#D1A08F"
        />
        <path
          d="M4.40398 87.374H5.00198C9.67798 87.374 12.131 89.9368 14.474 92.625C24.438 112.511 44.4553 126.487 67.8633 127.881C67.8613 127.882 67.8593 127.884 67.8573 127.885C66.581 127.961 65.295 128 64 128C36.903 128 13.74 111.16 4.40398 87.374Z"
          fill="#C68D7A"
        />
      </svg>
    </div>
  </div>
</template>

<style scoped lang="scss">
.preview {
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  perspective: 1000px;

  &__element {
    pointer-events: none;
    z-index: 1000;
    height: 100%;
    max-height: 128px;
    min-height: 32px;
    position: relative;
    transform-style: preserve-3d;
    will-change: transform;

    svg {
      display: block;
      height: 100%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      backface-visibility: hidden;
      transform-origin: center;

      &.back {
        transform: translate(-50%, -50%) rotateY(-180deg);
      }
    }
  }
}
</style>
